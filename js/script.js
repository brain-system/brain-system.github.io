function log(e){logContent.insertAdjacentHTML("beforeend","<div>"+e+"</div>")}let isManualDisconect=!1,deviceCache=null,characteristicCache=null;function connect(){navigator.bluetooth.getAvailability().then(e=>{e?(deviceCache?Promise.resolve(deviceCache):requestBluetoothDevice()).then(e=>connectDeviceAndCacheCharacteristic(e)).catch(e=>{log(e),bltNotFoundDlg.showModal()}):(log("Bluetooth is unavailable"),unavailableBltDlg.showModal())}).catch(e=>log(e))}function requestBluetoothDevice(){return log("Requesting bluetooth device..."),navigator.bluetooth.requestDevice({filters:[{name:["Vika-1"]}],optionalServices:[65280]}).then(e=>(log('"'+e.name+'" bluetooth device selected'),(deviceCache=e).addEventListener("gattserverdisconnected",handleDisconnection),deviceCache))}function handleDisconnection(e){if(connectControls.classList.remove("hidden"),disconnectControls.classList.add("hidden"),saveGamesBtn.disabled=!0,isManualDisconect)return;let t=e.target;log('"'+t.name+'" bluetooth device disconnected, trying to reconnect...'),connectDeviceAndCacheCharacteristic(t).catch(e=>log(e))}function connectDeviceAndCacheCharacteristic(e){return isManualDisconect=!1,e.gatt.connected&&characteristicCache?Promise.resolve(characteristicCache):(log("Connecting to GATT server..."),e.gatt.connect().then(e=>(log("GATT server connected, getting service..."),connectControls.classList.add("hidden"),disconnectControls.classList.remove("hidden"),saveGamesBtn.disabled=!1,e.getPrimaryService(65280))).then(e=>(log("Service found, getting characteristic..."),e.getCharacteristic(65281))).then(e=>(log("Characteristic found"),characteristicCache=e)))}function disconnect(){isManualDisconect=!0,deviceCache?(log('Disconnecting from "'+deviceCache.name+'" bluetooth device...'),deviceCache.gatt.connected?(deviceCache.gatt.disconnect(),log('"'+deviceCache.name+'" bluetooth device disconnected')):log('"'+deviceCache.name+'" bluetooth device is already disconnected')):log("Bluetooth device is already disconnected")}function checkMinMax(e){let t=e.value.trim();(""===t||isNaN(t))&&(t=e.getAttribute("value")),t=Math.min(Math.max(t,e.min),e.max),e.value!=t&&(e.value=t)}function saveGameRules(){if(log("Save game rules..."),!characteristicCache)return void log("Characteristic not found");let e=document.querySelector(".tabs").children,t=new Uint8Array(25*e.length),n=0;for(let a=0;a<e.length;a++){let c,i=e[a].elements,s="GT_ALL_PRESS"==i.gameType.value?1:0;e[a].classList.contains("active")&&(s|=128),t[n++]=s,t[n++]="TA_AFTER_QUESTION_START"==i.takeAnswer.value?1:0,t[n++]=i.falseStart.checked?1:0,t[n++]="FST_ALL"==i.falseStartType.value?1:0,t[n++]="FSB_TEMPORARILY"==i.falseStartBlock.value?1:0,c=Number(i.falseStartBlockTime.value),isNaN(c)&&(c=5),t[n++]=c,t[n++]=i.firstSecondRule.checked?1:0,t[n++]="OWA_NEXT_QUESTION"==i.onWrongAnswer.value?1:0,t[n++]="ONP_NEXT_ALREADY_PRESSED"==i.onNextPlayer.value?1:0,t[n++]="ORT_FULL_TIME"==i.onRestartThinkingTime.value?1:0,c="TM_UNLIMIT"==i.thinkingTimeMode.value?255:Number(i.thinkingTime.value),isNaN(c)&&(c=30),t[n++]=c,c="TM_UNLIMIT"==i.answerTimeMode.value?255:Number(i.answerTime.value),isNaN(c)&&(c=30),t[n++]=c,t[n++]=i.showFalseStart.checked?1:0,t[n++]=i.showWrongAnswer.checked?1:0,t[n++]=i.showNextReadyToAnswer.checked?1:0,t[n++]=i.sndQuestion.checked?1:0,t[n++]=i.sndStartThinking.checked?1:0,t[n++]=i.sndThinkingTimeout.checked?1:0,t[n++]=i.sndAnswerTimeout.checked?1:0,t[n++]=i.sndPlayerButton.checked?1:0,t[n++]=i.sndRightAnswer.checked?1:0,t[n++]=i.sndWrongAnswer.checked?1:0,t[n++]=i.sndFalseStart.checked?1:0,t[n++]=i.sndClock.checked?1:0,t[n++]=i.sndTikTok.checked?1:0}characteristicCache.writeValueWithResponse(t).then(()=>{log("Game rules saved")})}function getGameRules(){log("Get game rules..."),characteristicCache?characteristicCache.readValue().then(e=>{log("Game rules received"),document.querySelectorAll(".tabs>*, .tab-selector>*:not(#addGameBtn)").forEach(e=>{e.remove()}),addGameBtn.classList.remove("hidden"),deleteGameBtn.classList.add("hidden");let t=new Uint8Array(e.buffer),n=Math.min(Math.floor(t.length/25),6),a=0;for(let e=0;e<n&&255!=t[a];e++){let e,n=addGame(),c=n.elements;c.gameType.value=1==t[a++]?"GT_ALL_PRESS":"GT_FIRST_PRESS",c.takeAnswer.value=1==t[a++]?"TA_AFTER_QUESTION_START":"TA_AFTER_SIGNAL",c.falseStart.checked=0!=t[a++],c.falseStartType.value=1==t[a++]?"FST_ALL":"FST_ONLY_FIRST",c.falseStartBlock.value=1==t[a++]?"FSB_TEMPORARILY":"FSB_FULL",e=Number(t[a++]),isNaN(e)&&(e=5),c.falseStartBlockTime.value=e,c.firstSecondRule.checked=0!=t[a++],c.onWrongAnswer.value=1==t[a++]?"OWA_NEXT_QUESTION":"OWA_NEXT_PLAYER",c.onNextPlayer.value=1==t[a++]?"ONP_NEXT_ALREADY_PRESSED":"ONP_RESTART_THINKING_TIME",c.onRestartThinkingTime.value=1==t[a++]?"ORT_FULL_TIME":"ORT_REMAINDER",e=Number(t[a++]),c.thinkingTimeMode.value=255==e?"TM_UNLIMIT":"TM_LIMIT",(isNaN(e)||255==e)&&(e=30),c.thinkingTime.value=e,e=Number(t[a++]),c.answerTimeMode.value=255==e?"TM_UNLIMIT":"TM_LIMIT",(isNaN(e)||255==e)&&(e=30),c.answerTime.value=e,c.showFalseStart.checked=0!=t[a++],c.showWrongAnswer.checked=0!=t[a++],c.showNextReadyToAnswer.checked=0!=t[a++],c.sndQuestion.checked=0!=t[a++],c.sndStartThinking.checked=0!=t[a++],c.sndThinkingTimeout.checked=0!=t[a++],c.sndAnswerTimeout.checked=0!=t[a++],c.sndPlayerButton.checked=0!=t[a++],c.sndRightAnswer.checked=0!=t[a++],c.sndWrongAnswer.checked=0!=t[a++],c.sndFalseStart.checked=0!=t[a++],c.sndClock.checked=0!=t[a++],c.sndTikTok.checked=0!=t[a++],n.onchange()}}):log("Characteristic not found")}let elAudio=document.createElement("audio");function playSound(e){elAudio.pause(),elAudio.currentTime=0,elAudio.src="snd/"+e+".ogg",elAudio.play(),event.preventDefault(),event.stopPropagation()}function onOptionsChange(e){let t,n=e.elements;t="GT_FIRST_PRESS"!=n.gameType.value,n.fs_answerTime.disabled=t,n.fs_firstSecondRule.disabled=t,n.fs_onWrongAnswer.disabled=t,n.fs_onNextPlayer.disabled=t,n.fs_onRestartThinkingTime.disabled=t,t="TM_LIMIT"!=n.thinkingTimeMode.value,n.fs_onRestartThinkingTime.disabled=n.fs_onRestartThinkingTime.disabled||t,t="TA_AFTER_SIGNAL"!=n.takeAnswer.value,n.fs_falseStart.disabled=t,n.fs_falseStartType.disabled=t,n.fs_falseStartBlock.disabled=t,n.fs_firstSecondRule.disabled=n.fs_firstSecondRule.disabled||t,t=!n.falseStart.checked,n.fs_falseStartType.disabled=n.fs_falseStartType.disabled||t,n.fs_falseStartBlock.disabled=n.fs_falseStartBlock.disabled||t,t="OWA_NEXT_PLAYER"!=n.onWrongAnswer.value,n.fs_onNextPlayer.disabled=n.fs_onNextPlayer.disabled||t,n.fs_onRestartThinkingTime.disabled=n.fs_onRestartThinkingTime.disabled||t,t="ONP_RESTART_THINKING_TIME"!=n.onNextPlayer.value,n.fs_onRestartThinkingTime.disabled=n.fs_onRestartThinkingTime.disabled||t;let a=e.querySelector(".leds");a.children[0].classList.value="led",a.children[1].classList.value="led",a.children[5].classList.value="led";let c=n.showFalseStart.checked?1:0;n.showFalseStart.checked&&a.children[0].classList.add("false-start"),n.showWrongAnswer.checked&&a.children[c].classList.add("wrong-answer"),n.showNextReadyToAnswer.checked&&a.children[5].classList.add("next-answer")}function selectTab(e){let t=e.parentElement.children,n=0;for(let a=0;a<t.length;a++)t[a].classList.remove("active"),t[a]==e&&(n=a);e.classList.add("active"),t=document.querySelector(".tabs").children;for(let e=0;e<t.length;e++)t[e].classList.remove("active");t[n].classList.add("active")}function addGame(){let e=document.querySelector(".tab-selector"),t=e.children.length-1;e.children[t].insertAdjacentHTML("beforebegin",'<button onclick="selectTab(this)">'+(t+1)+"</button>"),t+1>=6&&addGameBtn.classList.add("hidden"),e.children.length>2&&deleteGameBtn.classList.remove("hidden");let n=gameTemplate.content.cloneNode(!0),a=n.children[0];return document.querySelector(".tabs").appendChild(n),a.onchange(),e.children[t].click(),a}function deleteGame(){let e=document.querySelector(".tab-selector"),t=document.querySelector(".tabs > .active");t.remove();let n=(t=e.querySelector(":scope > .active")).previousElementSibling?t.previousElementSibling:t.nextElementSibling;t.remove(),n.click();for(let t=0;t<e.children.length-1;t++)e.children[t].innerText=t+1;2==e.children.length&&deleteGameBtn.classList.add("hidden"),addGameBtn.classList.remove("hidden")}document.body.append(elAudio),addGame();